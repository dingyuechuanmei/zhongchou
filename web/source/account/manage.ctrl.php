<?php/** * [WeEngine System] Copyright (c) 2014 WE7.CC * WeEngine is NOT a free software, it under the license terms, visited http://www.we7.cc/ for more details. */defined('IN_IA') or exit('Access Denied');load()->func('file');load()->model('user');$dos = array('display', 'delete');$do = in_array($_GPC['do'], $dos)? $do : 'display';$_W['page']['title'] = $account_typename . '列表 - ' . $account_typename;$account_info = uni_user_account_permission();if ($do == 'display') {	$pindex = max(1, intval($_GPC['page']));	$psize = 20;	$condition = array();	$type_condition = array(		ACCOUNT_TYPE_APP_NORMAL => array(ACCOUNT_TYPE_APP_NORMAL),		ACCOUNT_TYPE_OFFCIAL_NORMAL => array(ACCOUNT_TYPE_OFFCIAL_NORMAL, ACCOUNT_TYPE_OFFCIAL_AUTH),	);	$condition['type'] = $type_condition[ACCOUNT_TYPE];	$keyword = trim($_GPC['keyword']);	if (!empty($keyword)) {		$condition['keyword'] = $keyword;	}	if(isset($_GPC['letter']) && strlen($_GPC['letter']) == 1) {		$condition['letter'] = trim($_GPC['letter']);	}	$account_lists = uni_account_list($condition, array($pindex, $psize));	$list = $account_lists['list'];    // 杭之鲜服务 赋予杭之鲜小程序的内容  start  // $hzx_key = 0;  // foreach ($list as $key => $value) {  //   if($value['uniacid'] == 61){  //     $hzx_key = $key;  //   }  // }  // unset($value);  // 杭之鲜小程序  // $hzx_wxapp_info = array();  // $hzx_wxapp_key = 0;  // foreach ($list as $key => &$value) {  //   if($value['uniacid'] == 77){  //     $hzx_wxapp_info = $value;  //     $hzx_wxapp_key = $key;  //     $hzx_wxapp_info['acid'] = $list[$hzx_key]['acid'];  //     $hzx_wxapp_info['uniacid'] = $list[$hzx_key]['uniacid'];  //   }  // }  // unset($list[$hzx_wxapp_key]);  // if(!empty($hzx_wxapp_info)){  //   $list[$hzx_key] = $hzx_wxapp_info;  // }  // 杭之鲜服务 赋予杭之鲜小程序的内容  end  // dump($list);die;  $total = $account_lists['total'];  $pager = pagination($total, $pindex, $psize);//  edit 微信绑定相关  if($_GET['account_type'] == 5){//    获得账号列表    $accont_list_w = pdo_fetchall("select * from ".tablename("account_wechats") . " where level != 5");//	  获得账号列表 end    if(isset($_POST['appid'])){      $mweixin = new WeiXinPlatform(array(        'key' => $_POST['appid'],      ));      $authorizer_access_token = $mweixin->getAccessToken();//      echo '$authorizer_access_token:'.$authorizer_access_token;      $componenttoken = $mweixin->getComponentAccesstoken();    }    if(isset($_POST['reqwechat'])){      switch ($_POST['reqwechat']){        case 1:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/modify_domain?access_token=$authorizer_access_token",json_encode(array(            "action" =>"set",            "requestdomain" => ["https://".$_SERVER["HTTP_HOST"]],            "wsrequestdomain" => ["wss://".$_SERVER["HTTP_HOST"]],            "uploaddomain" => ["https://".$_SERVER["HTTP_HOST"]],            "downloaddomain" => ["https://".$_SERVER["HTTP_HOST"]],          )));          break;        case 2:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/gettemplatedraftlist?access_token=$componenttoken");          break;        case 3:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/gettemplatelist?access_token=$componenttoken");          break;        case 4:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_category?access_token=$authorizer_access_token",array(),0);          break;        case 5:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_page?access_token=$authorizer_access_token",array(),0);          break;        case 6:          if(empty($_POST['item_list'])){            // 组装审核参数            // 首先获取类目和page列表            $rs_pg = WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_page?access_token=$authorizer_access_token",array(),0);            $rs_pg = json_decode($rs_pg);            $rs_pg = $rs_pg->page_list;            $rs_cat = WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_category?access_token=$authorizer_access_token",array(),0);            $rs_cat = json_decode($rs_cat);            $rs_cat = $rs_cat->category_list;            $review_arr = array();            foreach ($rs_pg as $k => $v){              if($k > 4 )break;              $review_arr['item_list'][$k] = array(                "address" => $v,                "tag" => $rs_cat[0]->first_class,                "first_class" => $rs_cat[0]->first_class,                "second_class" => $rs_cat[0]->second_class,                "third_class" => $rs_cat[0]->third_class,                "first_id" =>  $rs_cat[0]->first_id,                "second_id" =>  $rs_cat[0]->second_id,                "third_id"=> $rs_cat[0]->third_id,                "title" => $rs_cat[0]->first_class,              );            }            $review_arr = json_encode($review_arr,JSON_UNESCAPED_UNICODE);          }else{            $review_arr = json_encode(json_decode($_POST['item_list'],true));          }          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/submit_audit?access_token=$authorizer_access_token",$review_arr);          break;        case 7:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_latest_auditstatus?access_token=$authorizer_access_token",array(),0);          break;        case 8:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/release?access_token=$authorizer_access_token",'{}',1);          break;        case 9:          $rs = WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/get_qrcode?access_token=$authorizer_access_token",array(),0);          echo base64_encode($rs);          break;        case 100:          if( $_POST['uniacid'] == 77 ){            $_POST['uniacid'] = 61;          }//          $extJson = json_decode($_POST['ext_json'],true);          $extJson = array(            "extAppid"=> $_POST['appid'],            "ext"=> array(              "appid" => $_POST['appid'],              "api" => "https://xiaochengxu.bmwtech.cn/app/ewei_shopv2_api.php?i=".$_POST['uniacid'],              "approot" => "https://xiaochengxu.bmwtech.cn/addons/ewei_shopv2/"            ),            "extPages" => "",            "window" => "",            "tabBar" => "",            "networkTimeout" => array(              "request"       =>  10000,              "uploadFile"    =>  10000,              "downloadFile"  =>  10000,              "connectSocket" =>  10000            )          );          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/commit?access_token=$authorizer_access_token",json_encode(array(            "template_id" => $_POST['template_id'],            "ext_json" => json_encode( $extJson, JSON_UNESCAPED_UNICODE ),            "user_version" => $_POST['user_version'],            "user_desc" => $_POST['user_desc'],          )));          break;        case 101:          echo WeiXinPlatform::curlTouch("https://api.weixin.qq.com/wxa/addtotemplate?access_token=$componenttoken",json_encode(array(            "draft_id" => $_POST['draft_id'],          )));          break;      }      die;    }    template('account/manage-display-bindwxapp');//    edit end  }else{    template('account/manage-display' . ACCOUNT_TYPE_TEMPLATE);  }}if ($do == 'delete') {	$uniacid = intval($_GPC['uniacid']);	$acid = intval($_GPC['acid']);	$uid = $_W['uid'];	$type = intval($_GPC['type']);		$state = uni_permission($uid, $uniacid);	if ($state != ACCOUNT_MANAGE_NAME_OWNER && $state != ACCOUNT_MANAGE_NAME_FOUNDER) {		itoast('无权限操作！', url('account/manage'), 'error');	}	if (!empty($acid) && empty($uniacid)) {		$account = account_fetch($acid);		if (empty($account)) {			itoast('子公众号不存在或是已经被删除', '', '');		}		$uniaccount = uni_fetch($account['uniacid']);		if ($uniaccount['default_acid'] == $acid) {			itoast('默认子公众号不能删除', '', '');		}		pdo_update('account', array('isdeleted' => 1), array('acid' => $acid));		itoast('删除子公众号成功！您可以在回收站中回复公众号', referer(), 'success');	}	if (!empty($uniacid)) {		$account = pdo_get('uni_account', array('uniacid' => $uniacid));		if (empty($account)) {			itoast('抱歉，帐号不存在或是已经被删除', url('account/manage', array('account_type' => ACCOUNT_TYPE)), 'error');		}		$state = uni_permission($uid, $uniacid);		if($state != ACCOUNT_MANAGE_NAME_FOUNDER && $state != ACCOUNT_MANAGE_NAME_OWNER) {			itoast('没有该'. ACCOUNT_TYPE_NAME . '操作权限！', url('account/manage', array('account_type' => ACCOUNT_TYPE)), 'error');		}		pdo_update('account', array('isdeleted' => 1), array('uniacid' => $uniacid));		if($_GPC['uniacid'] == $_W['uniacid']) {			isetcookie('__uniacid', '');		}		cache_delete("uniaccount:{$uniacid}");		cache_delete("unisetting:{$uniacid}");	}	itoast('停用成功！，您可以在回收站中恢复', url('account/manage', array('account_type' => ACCOUNT_TYPE)), 'success');}